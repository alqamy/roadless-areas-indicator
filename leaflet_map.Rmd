---
output:
  html_document:
    css: "test.css"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(leaflet)
library(bcmaps)
library(sf)
library(dplyr)
library(rmapshaper)
library(mapview)
library(patchwork)
library(ggplot2)
library(purrr)

plot_list <- readRDS("tmp/plotlist.rds")

ecoreg <- ecoregions() %>% 
  ms_simplify() %>% 
  st_intersection(bc_bound()) %>% 
  st_transform(4326) %>% 
  group_by(ECOREGION_NAME) %>% 
  summarize() %>% 
  ms_simplify()

plot_list <- plot_list[ecoreg$ECOREGION_NAME]

popupGraph_list <- imap(plot_list, ~ {
  .x$barchart + .x$map + 
    plot_layout(widths = c(1, 1.5)) + 
    plot_annotation(title = tools::toTitleCase(tolower(.y)), 
                    theme = theme(title = element_text(size = 18)))
}) 

labels <- sprintf(
  "<strong>%s</strong>",
  tools::toTitleCase(tolower(ecoreg$ECOREGION_NAME))
) %>% lapply(htmltools::HTML)
```


```{r leaflet-map, echo=FALSE, message=FALSE, warning=FALSE}
leaflet(ecoreg, width = "900px", height = "550px") %>% 
  setView(lng = -126.5, lat = 54.5, zoom = 5, 
          options = list(minZoom = 5)) %>% 
  addProviderTiles("OpenStreetMap.BlackAndWhite") %>% 
  addPolygons(color = "#00441b", fillColor = "#006d2c",
              weight = 1, fillOpacity = 0.2,
              highlightOptions = highlightOptions(fillOpacity = 0.6,
                                                  weight = 2,
                                                  bringToFront = TRUE), 
              label = labels, 
              popup = popupGraph(popupGraph_list, type = "svg", width = 800, height = 400), 
              popupOptions = popupOptions(maxWidth = 800, autoPan = TRUE, 
                                          keepInView = TRUE, zoomAnimation = FALSE, 
                                          closeOnClick = TRUE, autoPanPadding = c(50, 50))) %>% 
  addEasyButton(easyButton(
     icon = htmltools::span('Reset to B.C.'),
     onClick = JS("function(btn, map) { 
                     map.closePopup();
                     map.setView({lon: -126.5, lat: 54.5}, 5);
                  }"), 
     position = "bottomleft", id = "reset-button"))
```
